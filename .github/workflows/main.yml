name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Install dependencies and prepare environment
      run: |
        sudo apt update && sudo apt install -y python3 python3-pip python3-venv
        python3 -m pip install --user pipx

    - name: Deploy using ssh
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          set -e
          pipx install pdm || true
          echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
          source ~/.bashrc
          pdm --version
          cd /root/dummy_projects/SSH_VM_TEMPLATE
          git pull origin main
          pdm install
          pdm venv activate
          pdm run python src/test_pipeline.py
